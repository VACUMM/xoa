

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xoa.cfgm &mdash; xoa 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> xoa
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configure.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usages.html">Usages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Commandline interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix.html">Appendices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xoa</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../xoa.html">xoa</a> &raquo;</li>
        
      <li>xoa.cfgm</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xoa.cfgm</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Configuration management utilities based on :mod:`configobj`&quot;&quot;&quot;</span>
<span class="c1"># Copyright or Â© or Copr. Shom/Ifremer/Actimar</span>
<span class="c1">#</span>
<span class="c1"># stephane.raynaud@shom.fr, charria@ifremer.fr, wilkins@actimar.fr</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to [describe</span>
<span class="c1"># functionalities and technical features of your software].</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL license under French law and</span>
<span class="c1"># abiding by the rules of distribution of free software.  You can  use,</span>
<span class="c1"># modify and/ or redistribute the software under the terms of the CeCILL</span>
<span class="c1"># license as circulated by CEA, CNRS and INRIA at the following URL</span>
<span class="c1"># &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and  rights to copy,</span>
<span class="c1"># modify and redistribute granted by the license, users are provided only</span>
<span class="c1"># with a limited warranty  and the software&#39;s author,  the holder of the</span>
<span class="c1"># economic rights,  and the successive licensors  have only  limited</span>
<span class="c1"># liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated</span>
<span class="c1"># with loading,  using,  modifying and/or developing or reproducing the</span>
<span class="c1"># software by the user in light of its specific status of free software,</span>
<span class="c1"># that may mean  that it is complicated to manipulate,  and  that  also</span>
<span class="c1"># therefore means  that it is reserved for developers  and  experienced</span>
<span class="c1"># professionals having in-depth computer knowledge. Users are therefore</span>
<span class="c1"># encouraged to load and test the software&#39;s suitability as regards their</span>
<span class="c1"># requirements in conditions enabling the security of their systems and/or</span>
<span class="c1"># data to be ensured and,  more generally, to use and operate it in the</span>
<span class="c1"># same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had</span>
<span class="c1"># knowledge of the CeCILL license and that you accept its terms.</span>


<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Action</span> <span class="k">as</span> <span class="n">AP_Action</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">HelpFormatter</span> <span class="k">as</span> <span class="n">ArgHelpFormatter</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">_HelpAction</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">validate</span>
<span class="kn">from</span> <span class="nn">configobj</span> <span class="kn">import</span> <span class="n">ConfigObj</span><span class="p">,</span> <span class="n">flatten_errors</span>
<span class="kn">from</span> <span class="nn">validate</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ValidateError</span><span class="p">,</span> <span class="n">Validator</span><span class="p">,</span> <span class="n">VdtMissingValue</span><span class="p">,</span> <span class="n">VdtTypeError</span><span class="p">,</span>
                      <span class="n">VdtValueTooBigError</span><span class="p">,</span> <span class="n">VdtValueTooSmallError</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.__init__</span> <span class="kn">import</span> <span class="n">XoaError</span><span class="p">,</span> <span class="n">XoaWarning</span><span class="p">,</span> <span class="n">xoa_warn</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">numpy</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="VdtWarning"><a class="viewcode-back" href="../../api/xoa.cfgm.VdtWarning.html#xoa.cfgm.VdtWarning">[docs]</a><span class="k">class</span> <span class="nc">VdtWarning</span><span class="p">(</span><span class="n">XoaWarning</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="XoaValidateError"><a class="viewcode-back" href="../../api/xoa.cfgm.XoaValidateError.html#xoa.cfgm.XoaValidateError">[docs]</a><span class="k">class</span> <span class="nc">XoaValidateError</span><span class="p">(</span><span class="n">ValidateError</span><span class="p">,</span> <span class="n">XoaError</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="VdtSizeError"><a class="viewcode-back" href="../../api/xoa.cfgm.VdtSizeError.html#xoa.cfgm.VdtSizeError">[docs]</a><span class="k">class</span> <span class="nc">VdtSizeError</span><span class="p">(</span><span class="n">XoaValidateError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List size is incorrect (nmin, nmax, odd, even or shape)&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<span class="k">def</span> <span class="nf">_valwrap_</span><span class="p">(</span><span class="n">validator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap a validation function to allow extraneous named arguments in specfile,</span>
<span class="sd">    this is usefull when getting specification with</span>
<span class="sd">    validator._parse_with_caching(configspec[section][option])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Already wrapped</span>
    <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
        <span class="s2">&quot;validator_wrapper-&quot;</span>
    <span class="p">)</span> <span class="ow">or</span> <span class="n">validator</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;list_validator_wrapper-&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">validator</span>

    <span class="c1"># Wrapper</span>
    <span class="k">def</span> <span class="nf">validator_wrapper</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Remove extraneous arguments the validator can&#39;t handle</span>
        <span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">validator</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argspec</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">validator_wrapper</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">validator</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="n">validator_wrapper</span>


<span class="k">def</span> <span class="nf">_valwraplist_</span><span class="p">(</span><span class="n">validator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap a validation function to handle list value using an existing validator</span>

<span class="sd">    This adds the following list checking behaviors that can be used as named</span>
<span class="sd">    arguments in specifications</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n:</span>
<span class="sd">        required fixed number of elements</span>
<span class="sd">    nmin:</span>
<span class="sd">        required minimum number of elements</span>
<span class="sd">    nmax:</span>
<span class="sd">        required maximum number of elements</span>
<span class="sd">    odd:</span>
<span class="sd">        number of elements must be odd</span>
<span class="sd">    even:</span>
<span class="sd">        number of elements must be even</span>
<span class="sd">    shape:</span>
<span class="sd">        check value shape (requires numpy)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Already wrapped</span>
    <span class="k">if</span> <span class="n">validator</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;list_validator_wrapper-&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">validator</span>

    <span class="c1"># Wrapper</span>
    <span class="k">def</span> <span class="nf">list_validator_wrapper</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Handle None and default</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">else</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>

        <span class="c1"># Handle single value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="c1"># Do list checks</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">VdtSizeError</span><span class="p">(</span>
                <span class="s2">&quot;Incorrect size: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2"> values expected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">nmin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nmin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">nmin</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">VdtSizeError</span><span class="p">(</span>
                <span class="s2">&quot;Incorrect size: </span><span class="si">{}</span><span class="s2">, at least </span><span class="si">{}</span><span class="s2"> values expected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">nmin</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nmax&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">nmax</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">VdtSizeError</span><span class="p">(</span>
                <span class="s2">&quot;Incorrect size: </span><span class="si">{}</span><span class="s2">, at most </span><span class="si">{}</span><span class="s2"> values expected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">nmax</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">odd</span> <span class="o">=</span> <span class="n">validate</span><span class="o">.</span><span class="n">is_boolean</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;odd&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">odd</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VdtSizeError</span><span class="p">(</span>
                <span class="s2">&quot;Incorrect size: </span><span class="si">{}</span><span class="s2">, odd number of values expected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">even</span> <span class="o">=</span> <span class="n">validate</span><span class="o">.</span><span class="n">is_boolean</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;even&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">even</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VdtSizeError</span><span class="p">(</span>
                <span class="s2">&quot;Incorrect size: </span><span class="si">{}</span><span class="s2">, even number of values expected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">numpy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot check shape, numpy package is missing&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shape</span><span class="p">,</span> <span class="n">vshape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">shape</span><span class="p">)),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">vshape</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">VdtSizeError</span><span class="p">(</span>
                            <span class="s2">&quot;Incorrect shape: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2"> shape expected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">vshape</span><span class="p">,</span> <span class="n">shape</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidateError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot test value shape, this may be caused by &quot;</span>
                        <span class="s2">&quot;an irregular array-like shape. Error was:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># Preserve tuple type</span>
        <span class="n">istuple</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

        <span class="c1"># Validate each values</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">validator</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">istuple</span> <span class="k">else</span> <span class="n">value</span>

    <span class="n">list_validator_wrapper</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">validator</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="n">list_validator_wrapper</span>


<div class="viewcode-block" id="validator_bbox"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_bbox.html#xoa.cfgm.validator_bbox">[docs]</a><span class="k">def</span> <span class="nf">validator_bbox</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse bbox coordinates with value format: x1,y1,x2,y2&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># two possible delimiters: whitespaces and &#39;,&#39;</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="n">c</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span></div>


<div class="viewcode-block" id="validator_numerics"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_numerics.html#xoa.cfgm.validator_numerics">[docs]</a><span class="k">def</span> <span class="nf">validator_numerics</span><span class="p">(</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of a tuple of numeric values&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;()[] &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">()</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="p">(</span><span class="n">val</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="validator_minmax"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_minmax.html#xoa.cfgm.validator_minmax">[docs]</a><span class="k">def</span> <span class="nf">validator_minmax</span><span class="p">(</span>
    <span class="n">value</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of a min,max pair&quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">validator_numerics</span><span class="p">(</span>
        <span class="n">value</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="validator_figsize"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_figsize.html#xoa.cfgm.validator_figsize">[docs]</a><span class="k">def</span> <span class="nf">validator_figsize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of a figure size (xsize,ysize)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">validator_numerics</span><span class="p">(</span>
        <span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="validator_interval"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_interval.html#xoa.cfgm.validator_interval">[docs]</a><span class="k">def</span> <span class="nf">validator_interval</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of an interval of coordinates (min, max [,bounds])&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;()[] &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="p">(</span><span class="n">val</span><span class="p">,)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;([co]{1,2}[ne]{0,2})&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="validator_cmap"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_cmap.html#xoa.cfgm.validator_cmap">[docs]</a><span class="k">def</span> <span class="nf">validator_cmap</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator that return a :`xoa.color.CmapAdapter`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="kn">from</span> <span class="nn">.color</span> <span class="kn">import</span> <span class="n">CmapAdapter</span>

    <span class="c1"># if isinstance(value, str) and value.startswith(&quot;[&quot;):</span>
    <span class="c1">#     value = eval(value)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.color</span> <span class="kn">import</span> <span class="n">cmap_custom</span>

        <span class="k">return</span> <span class="n">cmap_custom</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CmapAdapter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="VdtDateTimeError"><a class="viewcode-back" href="../../api/xoa.cfgm.VdtDateTimeError.html#xoa.cfgm.VdtDateTimeError">[docs]</a><span class="k">class</span> <span class="nc">VdtDateTimeError</span><span class="p">(</span><span class="n">ValidateError</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="validator_path"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_path.html#xoa.cfgm.validator_path">[docs]</a><span class="k">def</span> <span class="nf">validator_path</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a value as a path</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expand:</span>
<span class="sd">        expandvars and expandhome on loaded path</span>

<span class="sd">    **Warning: expand currently can&#39;t work with interpolation**</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: fix interpolation and expand !</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">if</span> <span class="n">expand</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="validator_pydatetime"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_pydatetime.html#xoa.cfgm.validator_pydatetime">[docs]</a><span class="k">def</span> <span class="nf">validator_pydatetime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse value as a :class:`datetime.datetime` object&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">datetime</span>

    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VdtDateTimeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<span class="c1"># def validator_timeunits(value, default=&quot;days since 1950-01-01&quot;):</span>
<span class="c1">#     &quot;&quot;&quot;Validator of standard time units&quot;&quot;&quot;</span>
<span class="c1">#     from .atime import are_valid_units</span>
<span class="c1">#     value = str(value)</span>
<span class="c1">#     if value == &quot;None&quot; or not value:</span>
<span class="c1">#         value = default</span>
<span class="c1">#     if not are_valid_units(value):</span>
<span class="c1">#         raise VdtTypeError(value)</span>
<span class="c1">#     return value</span>


<div class="viewcode-block" id="validator_cdtime"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_cdtime.html#xoa.cfgm.validator_cdtime">[docs]</a><span class="k">def</span> <span class="nf">validator_cdtime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of a date (compatible with :func:`cdtime.s2c`)&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">cdtime</span>

    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">s2c</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">s2c</span><span class="p">(</span><span class="nb">min</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">VdtValueTooSmallError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">s2c</span><span class="p">(</span><span class="nb">max</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">VdtValueTooBigError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="validator_timestamp"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_timestamp.html#xoa.cfgm.validator_timestamp">[docs]</a><span class="k">def</span> <span class="nf">validator_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of date as parsable by :func:`pandas.Timestamp`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="validator_timedelta"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_timedelta.html#xoa.cfgm.validator_timedelta">[docs]</a><span class="k">def</span> <span class="nf">validator_timedelta</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of date as parsable by :func:`pandas.Timedelta`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VdtDateTimeError</span><span class="p">(</span><span class="s2">&quot;Need value and unit&quot;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="validator_timedelta64"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_timedelta64.html#xoa.cfgm.validator_timedelta64">[docs]</a><span class="k">def</span> <span class="nf">validator_timedelta64</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of date as parsable by :func:`numpy.timedelta64`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VdtDateTimeError</span><span class="p">(</span><span class="s2">&quot;Need value and unit&quot;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="validator_datetime"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_datetime.html#xoa.cfgm.validator_datetime">[docs]</a><span class="k">def</span> <span class="nf">validator_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator to magically create a :class:`datetime.datetime`&quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">validator_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span></div>


<div class="viewcode-block" id="validator_datetime64"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_datetime64.html#xoa.cfgm.validator_datetime64">[docs]</a><span class="k">def</span> <span class="nf">validator_datetime64</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator to create a :class:`numpy.datetime64`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="n">validator_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">to_datetime64</span><span class="p">()</span></div>


<div class="viewcode-block" id="validator_daterange"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_daterange.html#xoa.cfgm.validator_daterange">[docs]</a><span class="k">def</span> <span class="nf">validator_daterange</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of a date range created with :func:`pandas.date_range`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">VdtDateTimeError</span><span class="p">(</span><span class="s2">&quot;Need startdate, end date and step&quot;</span><span class="p">)</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">time_range</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">closed</span><span class="p">)</span></div>


<div class="viewcode-block" id="validator_daterange64"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_daterange64.html#xoa.cfgm.validator_daterange64">[docs]</a><span class="k">def</span> <span class="nf">validator_daterange64</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validator of a date range created with :func:`numpy.arange`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">VdtDateTimeError</span><span class="p">(</span><span class="s2">&quot;Need startdate, end date and step&quot;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;M8[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span></div>


<div class="viewcode-block" id="validator_eval"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_eval.html#xoa.cfgm.validator_eval">[docs]</a><span class="k">def</span> <span class="nf">validator_eval</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unchanged_if_failed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate a string that can be evaluated&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unchanged_if_failed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="validator_color"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_color.html#xoa.cfgm.validator_color">[docs]</a><span class="k">def</span> <span class="nf">validator_color</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">as256</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ColorConverter</span>

    <span class="n">CC</span> <span class="o">=</span> <span class="n">ColorConverter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">alpha</span><span class="p">:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">to_rgba</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">to_rgb</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cc</span><span class="p">(</span><span class="n">_check256_</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">as256</span><span class="o">=</span><span class="n">as256</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cc</span><span class="p">(</span><span class="n">_check256_</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">as256</span><span class="o">=</span><span class="n">as256</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_check256_</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">as256</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">if</span> <span class="n">as256</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">as256</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[:</span><span class="mi">3</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">as256</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">v</span> <span class="o">/</span> <span class="mf">256.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[:</span><span class="mi">3</span><span class="p">]])</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="n">_re_funccall</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*(\w+\(.*\))\s*$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>  <span class="c1"># func(...)</span>
<span class="n">_re_acc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*(\{.*\})\s*$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>  <span class="c1"># {...}</span>
<span class="n">_re_set</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*(\w+)\s*=\s*(.+)\s*$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>  <span class="c1"># a=b</span>


<div class="viewcode-block" id="validator_dict"><a class="viewcode-back" href="../../api/xoa.cfgm.validator_dict.html#xoa.cfgm.validator_dict">[docs]</a><span class="k">def</span> <span class="nf">validator_dict</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{},</span> <span class="n">vtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;validator for dictionaries</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    value:</span>

<span class="sd">        - dict(a=2, b=&quot;x&quot;)</span>
<span class="sd">        - {&quot;a&quot;:2, &quot;b&quot;:&quot;x&quot;}</span>
<span class="sd">        - a=2</span>
<span class="sd">        - a=2, b=&quot;x&quot;</span>
<span class="sd">        - OrderedDict(b=2)</span>
<span class="sd">        - dict([(&quot;a&quot;,2),(&quot;b&quot;,&quot;x&quot;)])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_re_funccall</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_re_acc</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_re_set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;dict(&quot;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
    <span class="k">raise</span> <span class="n">VdtTypeError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<span class="c1"># Define additionnal specifications</span>
<span class="c1"># Value should be dict for internal use of this module (iterable, opttype, ...)</span>
<span class="c1"># If value is not a dict, it is supposed to be the validator function</span>


<span class="c1">#: Available VACUMM :mod:`configobj` validator specifications</span>
<span class="n">VALIDATOR_SPECS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># copy of some validate.Validator.functions to later build plural forms</span>
    <span class="s2">&quot;integer&quot;</span><span class="p">:</span> <span class="n">validate</span><span class="o">.</span><span class="n">is_integer</span><span class="p">,</span>
    <span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="n">validate</span><span class="o">.</span><span class="n">is_float</span><span class="p">,</span>
    <span class="s2">&quot;boolean&quot;</span><span class="p">:</span> <span class="n">validate</span><span class="o">.</span><span class="n">is_boolean</span><span class="p">,</span>
    <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="n">validate</span><span class="o">.</span><span class="n">is_string</span><span class="p">,</span>
    <span class="c1"># single value</span>
    <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">validator_cdtime</span><span class="p">,</span>
    <span class="s2">&quot;cdtime&quot;</span><span class="p">:</span> <span class="n">validator_cdtime</span><span class="p">,</span>
    <span class="s2">&quot;pydatetime&quot;</span><span class="p">:</span> <span class="n">validator_pydatetime</span><span class="p">,</span>
    <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">validator_datetime</span><span class="p">,</span>
    <span class="s2">&quot;datetime64&quot;</span><span class="p">:</span> <span class="n">validator_datetime64</span><span class="p">,</span>
    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">validator_timestamp</span><span class="p">,</span>
    <span class="s2">&quot;daterange&quot;</span><span class="p">:</span> <span class="n">validator_daterange</span><span class="p">,</span>
    <span class="c1"># &quot;timeunits&quot;: validator_timeunits,</span>
    <span class="s2">&quot;minmax&quot;</span><span class="p">:</span> <span class="n">validator_minmax</span><span class="p">,</span>
    <span class="s2">&quot;numerics&quot;</span><span class="p">:</span> <span class="n">validator_numerics</span><span class="p">,</span>
    <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="n">validator_figsize</span><span class="p">,</span>
    <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="n">validator_bbox</span><span class="p">,</span>
    <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">validator_datetime</span><span class="p">,</span>
    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">validator_path</span><span class="p">,</span>
    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">validator_path</span><span class="p">,</span>
    <span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">validator_path</span><span class="p">,</span>
    <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="n">validator_interval</span><span class="p">,</span>
    <span class="s2">&quot;eval&quot;</span><span class="p">:</span> <span class="n">validator_eval</span><span class="p">,</span>
    <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="n">validator_cmap</span><span class="p">,</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">validator_color</span><span class="p">,</span>
    <span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="n">validator_dict</span><span class="p">,</span>
    <span class="c1"># lists validators for these scalars will be automatically generated</span>
<span class="p">}</span>

<span class="c1">#: Available :mod:`validate.Validator` validator functions</span>
<span class="n">VALIDATOR_FUNCTIONS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">#: Available VACUMM :mod:`configobj` validator type names</span>
<span class="n">VALIDATOR_TYPES</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">_update_registry_</span><span class="p">():</span>

    <span class="c1"># 1. Fix specs dicts</span>
    <span class="c1"># 2. Generate list validators</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">VALIDATOR_SPECS</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="c1"># Check type of spec</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
            <span class="c1"># Update specs mapping</span>
            <span class="n">VALIDATOR_SPECS</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># Check minimum settings</span>
        <span class="n">v</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">.</span><span class="n">is_string</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;base_func&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">])</span>
        <span class="n">v</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_valwrap_</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">])</span>
        <span class="n">v</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;iterable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;opttype&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;argtype&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">])</span>

        <span class="c1"># Add plural forms and validators to handle list values</span>
        <span class="c1"># TODO: we should remove this plural form which is not really correct</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">):</span>
            <span class="n">nk</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;ies&quot;</span>
        <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">):</span>
            <span class="n">nk</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;es&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nk</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span>
        <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="p">(</span><span class="n">nk</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;_list&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALIDATOR_SPECS</span><span class="p">:</span>
                <span class="n">nv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">nv</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_valwraplist_</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">])</span>
                <span class="n">nv</span><span class="p">[</span><span class="s2">&quot;iterable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">VALIDATOR_SPECS</span><span class="p">[</span><span class="n">nk</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span>

    <span class="c1"># List of names</span>
    <span class="n">VALIDATOR_TYPES</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">VALIDATOR_TYPES</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">VALIDATOR_SPECS</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">VALIDATOR_TYPES</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c1"># Dict of functions</span>
    <span class="n">VALIDATOR_FUNCTIONS</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">VALIDATOR_FUNCTIONS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">VALIDATOR_SPECS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;func&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>


<span class="n">_update_registry_</span><span class="p">()</span>

<span class="n">_for_doc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">VALIDATOR_TYPES</span><span class="p">:</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">VALIDATOR_SPECS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;list_validator_wrapper&quot;</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;:func:`</span><span class="si">{}</span><span class="s2"> &lt;</span><span class="si">{}</span><span class="s2">&gt;`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;base_func&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;:func:`</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">_for_doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="vm">__doc__</span> <span class="o">=</span> <span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_for_doc</span><span class="p">))</span>


<div class="viewcode-block" id="register_config_validator"><a class="viewcode-back" href="../../api/xoa.cfgm.register_config_validator.html#xoa.cfgm.register_config_validator">[docs]</a><span class="k">def</span> <span class="nf">register_config_validator</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a new configobj validator function</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    .. ipython:: python</span>

<span class="sd">        @suppress</span>
<span class="sd">        from xoa.cfgm import register_config_validator</span>

<span class="sd">        def upper_string(mystr, default=&quot;&quot;):</span>
<span class="sd">            mystr = str(mystr)</span>
<span class="sd">            if mystr == &quot;None&quot;:</span>
<span class="sd">                mystr = &quot;&quot;</span>
<span class="sd">            return str(mystr).upper()</span>

<span class="sd">        register_config_validator(upper_string=upper_string)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">VALIDATOR_SPECS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">_update_registry_</span><span class="p">()</span></div>


<div class="viewcode-block" id="ConfigManager"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.html#xoa.cfgm.ConfigManager">[docs]</a><span class="k">class</span> <span class="nc">ConfigManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A configuration management class based on :class:`configobj`</span>

<span class="sd">    It supports content verification and default values thanks to</span>
<span class="sd">    :class:`validate.Validator`.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; Cfg = Config(&#39;config.ini&#39;, interpolation=&#39;template&#39;)</span>
<span class="sd">    &gt;&gt;&gt; Cfg.opt_parse()</span>
<span class="sd">    &gt;&gt;&gt; cfg = Cfg.load(&#39;config.cfg&#39;)</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    :class:`configobj.ConfigObj`, :class:`validate.Validator`</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConfigManager.__init__"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.html#xoa.cfgm.ConfigManager.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cfgspecfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;template&quot;</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">boolean_false</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">splitsecdesc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cfgfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cfgfilter_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">warn_empty_specs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cfgspecfile: optional</span>
<span class="sd">            The specification file to be used with this.</span>
<span class="sd">        validator: :class:`validate.Validator`</span>
<span class="sd">            A custom :class:`validate.Validator`</span>
<span class="sd">            to use or a mapping dict of validator functions.</span>
<span class="sd">        interpolation: optional</span>
<span class="sd">            See :class:`configobj.ConfigObj`.</span>
<span class="sd">        boolean_false: optional</span>
<span class="sd">            Make sure that booleans have a default value.</span>
<span class="sd">        splitsecdesc: optional</span>
<span class="sd">            Section descriptions are split in two</span>
<span class="sd">            components separated by &#39;:&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Specifications</span>
        <span class="c1"># - load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfgspecfile</span><span class="p">,</span> <span class="n">ConfigObj</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span> <span class="o">=</span> <span class="n">cfgspecfile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span> <span class="o">=</span> <span class="n">ConfigObj</span><span class="p">(</span>
                <span class="n">cfgspecfile</span><span class="p">,</span>
                <span class="n">list_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
                <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">file_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn_empty_specs</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Empty Config specifications&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># - filter</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfgfilter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">filter_section</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="p">,</span> <span class="n">cfgfilter</span><span class="p">,</span> <span class="n">cfgfilter_default</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cfgfilter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span> <span class="ow">and</span> <span class="n">warn_empty_specs</span><span class="p">:</span>
                <span class="n">xoa_warn</span><span class="p">(</span><span class="s2">&quot;Empty Config specifications after filtering&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfgfilter</span> <span class="o">=</span> <span class="n">cfgfilter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfgfilter_default</span> <span class="o">=</span> <span class="n">cfgfilter_default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configspecfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="o">.</span><span class="n">filename</span>

        <span class="c1"># Validator</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="n">Validator</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="n">validator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="n">get_validator</span><span class="p">(</span><span class="n">functions</span><span class="o">=</span><span class="n">validator</span><span class="p">)</span>

        <span class="c1"># Makes sure that booleans have a default value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_false</span> <span class="o">=</span> <span class="n">boolean_false</span>
        <span class="k">if</span> <span class="n">boolean_false</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span>
                <span class="n">_walker_set_boolean_false_by_default_</span><span class="p">,</span>
                <span class="n">validator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_validator</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Interpolation</span>
        <span class="k">if</span> <span class="n">interpolation</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">interpolation</span> <span class="o">=</span> <span class="s2">&quot;template&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interpolation</span> <span class="o">=</span> <span class="n">interpolation</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span>

    <span class="n">cfgspecs</span> <span class="o">=</span> <span class="n">configspecs</span> <span class="o">=</span> <span class="n">specs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span>

<div class="viewcode-block" id="ConfigManager.get_spec"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.get_spec.html#xoa.cfgm.ConfigManager.get_spec">[docs]</a>    <span class="k">def</span> <span class="nf">get_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See :func:`get_spec`</span>

<span class="sd">        If sec is a basestring, use configspec[sec][key]</span>
<span class="sd">        Otherwise use sec as a configspec, sec[key]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_spec</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="p">[</span><span class="n">sec</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">sec</span><span class="p">)[</span><span class="n">key</span><span class="p">],</span>
            <span class="n">validator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_validator</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ConfigManager.get_defaults"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.get_defaults.html#xoa.cfgm.ConfigManager.get_defaults">[docs]</a>    <span class="k">def</span> <span class="nf">get_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nocomments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the default config</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nocomments: boolean</span>
<span class="sd">            Do not include option comments in config file.</span>
<span class="sd">            If equal to 2, remove section comments too.</span>
<span class="sd">        interpolation: optional</span>
<span class="sd">            If True, interpolate values.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        A :class:`~configobj.ConfigObj` instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">interpolation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">interpolation</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">interpolation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpolation</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigObj</span><span class="p">(</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
            <span class="n">configspec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_validator</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nocomments</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span>
                <span class="n">_walker_remove_all_comments_</span><span class="p">,</span>
                <span class="n">call_on_sections</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nocomments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">inline_comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="o">.</span><span class="n">inline_comments</span>
        <span class="k">return</span> <span class="n">cfg</span></div>

<div class="viewcode-block" id="ConfigManager.reset"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.reset.html#xoa.cfgm.ConfigManager.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cfgfile</span><span class="o">=</span><span class="s2">&quot;config.cfg&quot;</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nocomments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset a config file to default values</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cfgfile: optional</span>
<span class="sd">            The configuration file to reset.</span>
<span class="sd">        backup: optional</span>
<span class="sd">            Backup the old config file.</span>
<span class="sd">        nocomments: optional</span>
<span class="sd">            Do not include comment in config file.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        :class:`~configobj.ConfigObj`</span>
<span class="sd">            A :class:`~configobj.ConfigObj` instance</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`defaults`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Load defaults</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">(</span><span class="n">nocomments</span><span class="o">=</span><span class="n">nocomments</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Remove old file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfgfile</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">backup</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cfgfile</span><span class="p">,</span> <span class="n">cfgfile</span> <span class="o">+</span> <span class="s2">&quot;.bak&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cfgfile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backup</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Write to new one</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">cfgfile</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created default config file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfgfile</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">backup</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backuped old config file to: </span><span class="si">{}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfgfile</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cfg</span></div>

<div class="viewcode-block" id="ConfigManager.load"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.load.html#xoa.cfgm.ConfigManager.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cfgfile</span><span class="o">=</span><span class="s2">&quot;config.cfg&quot;</span><span class="p">,</span>
        <span class="n">patch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cfgfilter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwpatch</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a :class:`~configobj.ConfigObj` instance loaded from a file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cfgfile: optional</span>
<span class="sd">            config file</span>

<span class="sd">            - a config file name</span>
<span class="sd">            - a :class:`~configobj.ConfigObj` instance</span>
<span class="sd">            - ``None``: defaults to ``&quot;config.cfg&quot;``</span>

<span class="sd">        patch:</span>
<span class="sd">            A :class:`~configobj.ConfigObj` instance, a config file or</span>
<span class="sd">            a dictionary, used for patching.</span>
<span class="sd">        validate: optional</span>
<span class="sd">            Type of validation</span>

<span class="sd">            - ``False``: no validation</span>
<span class="sd">            - ``&quot;fix&quot;``: validation fixes and reports errors</span>
<span class="sd">            - ``&quot;report&quot;``: validation reports errors</span>
<span class="sd">            - ``&quot;raise&quot;``: validation raises errors</span>

<span class="sd">        force: optional</span>
<span class="sd">            Force re-instantiation of ``cfgfile`` when it is already</span>
<span class="sd">            a :class:`ConfigObj` instance.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        tuple, :class:`~configobj.ConfigObj`</span>
<span class="sd">            Depends on ``geterr``</span>

<span class="sd">            - if ``True``: ``(cfg, err)`` where is the result</span>
<span class="sd">              of :meth:`~configobj.ConfigObj.validate`</span>
<span class="sd">            - else: ``cfg`` (:class:`~configobj.ConfigObj` instance)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Load the config</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">cfgfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfgfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfgfile</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">cfgfile</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Instantiate / Copy</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfgfile</span><span class="p">,</span> <span class="n">ConfigObj</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigObj</span><span class="p">(</span>
                <span class="n">cfgfile</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_interpolation</span><span class="p">,</span>
                <span class="n">configspec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfgfile</span>

        <span class="c1"># Patch</span>
        <span class="k">if</span> <span class="n">kwpatch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">patch</span><span class="p">:</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwpatch</span><span class="p">:</span>  <span class="c1"># Patch the patch!</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">kwpatch</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Filter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfgfilter</span> <span class="ow">and</span> <span class="n">cfgfilter</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfgfilter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">cfgfilter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfgfilter</span>
            <span class="n">filter_section</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfgfilter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfgfilter_default</span><span class="p">)</span>

        <span class="c1"># Validation</span>
        <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="p">:</span>

            <span class="c1"># Validation itself</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_validator</span><span class="p">,</span> <span class="n">preserve_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Loop on errors</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">sections</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">flatten_errors</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>

                    <span class="c1"># Format explicit message</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">):</span>
                        <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="s2">&quot;][&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;] &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Config value error: </span><span class="si">{}{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">section</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="c1"># Raise explicit error</span>
                    <span class="k">raise</span> <span class="n">XoaValidateError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cfg</span></div>

<div class="viewcode-block" id="ConfigManager.patch"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.patch.html#xoa.cfgm.ConfigManager.patch">[docs]</a>    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cfgpatch</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace config values of ``cfg`` by those of ``cfgpatch``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cfg:</span>
<span class="sd">            A :class:`~configobj.ConfigObj` instance, a config file or</span>
<span class="sd">            a dictionary, that must be patched.</span>
<span class="sd">        cfgpatch:</span>
<span class="sd">            A :class:`~configobj.ConfigObj` instance, a config file or</span>
<span class="sd">            a dictionary, used for patching.</span>
<span class="sd">        validate: optional</span>
<span class="sd">            If ``True``, validate configs if they have a valid config spec.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ConfigObj</span><span class="p">):</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigObj</span><span class="p">(</span>
                <span class="n">cfg</span><span class="p">,</span> <span class="n">configspec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span>
            <span class="p">)</span>  <span class="c1"># , interpolation=False)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfgpatch</span><span class="p">,</span> <span class="n">ConfigObj</span><span class="p">):</span>
            <span class="n">cfgpatch</span> <span class="o">=</span> <span class="n">ConfigObj</span><span class="p">(</span>
                <span class="n">cfgpatch</span><span class="p">,</span>
                <span class="n">configspec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_configspec</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cfgpatch</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Merging based on specs with type check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfgspecs</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_walker_patch_</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfgpatch</span><span class="o">=</span><span class="n">cfgpatch</span><span class="p">)</span>

        <span class="c1"># Merging of missing stuff</span>
        <span class="n">cfgpatch</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_walker_patch_</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfgpatch</span><span class="o">=</span><span class="n">cfgpatch</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">configspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cfg</span></div>

<div class="viewcode-block" id="ConfigManager.arg_parse"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.arg_parse.html#xoa.cfgm.ConfigManager.arg_parse">[docs]</a>    <span class="k">def</span> <span class="nf">arg_parse</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">exc</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">parse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">getparser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">getargs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cfgfile</span><span class="o">=</span><span class="s2">&quot;config.cfg&quot;</span><span class="p">,</span>
        <span class="n">patch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cfgfileopt</span><span class="o">=</span><span class="s2">&quot;--cfgfile&quot;</span><span class="p">,</span>
        <span class="n">cfgfilepatch</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">,</span>
        <span class="n">nested</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extraopts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Options (:mod:`argparse`) and config mixer.</span>

<span class="sd">            1. Creates command-line options from config defaults</span>
<span class="sd">            2. Parse command-line argument and create a configuration patch</span>

<span class="sd">        For instance, the following config define the commandline option</span>
<span class="sd">        ``--section1-my-section2-my-key`` with ``value`` as a default value,</span>
<span class="sd">        stored in a special group of options with a short name</span>
<span class="sd">        and a long description::</span>

<span class="sd">            [section1] # Short name : long description of the group</span>
<span class="sd">                [[my_section2]]</span>
<span class="sd">                    my_key=value</span>

<span class="sd">        .. warning:: Section and option names must not contain any</span>
<span class="sd">            space-like character !</span>

<span class="sd">        .. note::</span>

<span class="sd">            If you want to prevent conflict of options, don&#39;t use ``&quot;_&quot;`` in</span>
<span class="sd">            section and option names.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parser:</span>
<span class="sd">            optional, a default one is created if not given. This can be:</span>
<span class="sd">                - a :class:`OptionParser` instance</span>
<span class="sd">                - a :class:`dict` with keyword arguments for the one</span>
<span class="sd">                  to be created</span>
<span class="sd">        exc: optional, list</span>
<span class="sd">            List of keys to be excluded from parsing.</span>
<span class="sd">        parse: optional, bool</span>
<span class="sd">            If ``True``, parse commande line options and arguments</span>
<span class="sd">        args: optional</span>
<span class="sd">            List of arguments to parse instead of default sys.argv[1:]</span>
<span class="sd">        getparser: optional, bool</span>
<span class="sd">            Allow getting the parser in addition to the config if parse=True</span>
<span class="sd">        getargs: optional, bool</span>
<span class="sd">            allow getting the parsed arguments in addition to the</span>
<span class="sd">            config if parse=True</span>
<span class="sd">        patch: optional</span>
<span class="sd">            Used if parse is True.</span>
<span class="sd">            Can take the following values:</span>

<span class="sd">            - a :class:`bool` value indicating wheter to apply</span>
<span class="sd">              defaults on the returned config</span>
<span class="sd">              before applying the command line config</span>
<span class="sd">            - a :class:`ConfigObj` instance to apply on the returned config</span>
<span class="sd">              before applying the command line config</span>

<span class="sd">        cfgfileopt: optional</span>
<span class="sd">            If present a config file option will be added.</span>
<span class="sd">            Can be a :class:`string` or couple of strings to use</span>
<span class="sd">            as the option short and/or long name</span>
<span class="sd">        cfgfilepatch:</span>
<span class="sd">            specify if the returned config must be patched if a</span>
<span class="sd">            config file command line option is provided and when to patch it.</span>
<span class="sd">            Can take the following values:</span>

<span class="sd">            - True or &#39;before&#39;: the config file would be used before</span>
<span class="sd">              command line options</span>
<span class="sd">            - &#39;after&#39;: the config file would be used after command line options</span>
<span class="sd">            - Any False like value: the config file would not be used</span>

<span class="sd">        nested: str</span>
<span class="sd">            Name of a section whose defines the configuration.</span>
<span class="sd">            It must be used when the configuration in nested in more g</span>
<span class="sd">            eneral configuration.</span>
<span class="sd">        extraopts: dict</span>
<span class="sd">            Extra options to declare in the form</span>
<span class="sd">            ``[(args1, kwargs1), ((args2, kwargs2), ...]``</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        :class:`OptionParser`</span>
<span class="sd">            if parse is False</span>
<span class="sd">        :class:`~configobj.ConfigObj`</span>
<span class="sd">            if parse is True and getparser is not True</span>
<span class="sd">        (:class:`~configobj.ConfigObj`, :class:`OptionParser`)</span>
<span class="sd">            if both parse and getparser are True</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Prepare the option parser</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">parser</span><span class="p">[</span><span class="s2">&quot;add_help&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="o">**</span><span class="n">parser</span><span class="p">)</span>

        <span class="c1"># Add short and long helps</span>
        <span class="n">old_conflict_handler</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_optionals</span><span class="o">.</span><span class="n">conflict_handler</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">_optionals</span><span class="o">.</span><span class="n">conflict_handler</span> <span class="o">=</span> <span class="s2">&quot;resolve&quot;</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--help&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">_AP_ShortHelpAction</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show a reduced help and exit&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--long-help&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">_HelpAction</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show an extended help and exit&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--short-help&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">_AP_VeryShortHelpAction</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show a very reduced help and exit&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">_optionals</span><span class="o">.</span><span class="n">conflict_handler</span> <span class="o">=</span> <span class="n">old_conflict_handler</span>

        <span class="c1"># Add extra options first</span>
        <span class="k">if</span> <span class="n">extraopts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">eopt</span> <span class="ow">in</span> <span class="n">extraopts</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eopt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eopt</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">eargs</span> <span class="o">=</span> <span class="n">eopt</span>
                        <span class="n">ekwargs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">eargs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">ekwargs</span> <span class="o">=</span> <span class="n">eopt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">eargs</span><span class="p">,</span> <span class="n">ekwargs</span> <span class="o">=</span> <span class="n">eopt</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="o">*</span><span class="n">eargs</span><span class="p">,</span> <span class="o">**</span><span class="n">ekwargs</span><span class="p">)</span>

        <span class="c1"># Add the cfgfile option (configurable)</span>
        <span class="k">if</span> <span class="n">cfgfileopt</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfgfileopt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cfgfileopt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cfgfileopt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">cfgfileopt</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">cfgfileopt</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cfgfileopt</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">cfgfileopt</span>
                <span class="n">cfgfileopt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfgfileopt</span><span class="p">,)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="o">*</span><span class="n">cfgfileopt</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;cfgfile&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;user configuration file that overrides defauts&quot;</span>
                <span class="s1">&#39; [default: &quot;</span><span class="si">{default}</span><span class="s1">&quot;]&#39;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">cfgfile</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Default config</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">()</span>

        <span class="c1"># Create global group of options from defaults</span>
        <span class="c1"># - inits</span>
        <span class="n">re_match_initcom</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;#\s*-\*-\s*coding\s*:\s*\S+\s*-\*-\s*&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">match</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">initial_comment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">or</span> <span class="n">re_match_initcom</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">initial_comment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;global configuration options&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">re_match_initcom</span><span class="p">(</span>
                <span class="n">defaults</span><span class="o">.</span><span class="n">initial_comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">),</span> <span class="n">defaults</span><span class="o">.</span><span class="n">initial_comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">icom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">re_match_initcom</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">initial_comment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">initial_comment</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">icom</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">initial_comment</span><span class="p">[</span><span class="n">icom</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;# &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">)</span>
        <span class="c1"># - global options</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">scalars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">_walker_argcfg_setarg_</span><span class="p">(</span>
                    <span class="n">defaults</span><span class="p">,</span>
                    <span class="n">key</span><span class="p">,</span>
                    <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
                    <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span>
                    <span class="n">nested</span><span class="o">=</span><span class="n">nested</span><span class="p">,</span>
                    <span class="n">boolean_false</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_boolean_false</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1">#                group.add_argument(&#39;--&#39;+_cfg2optname_(key, nested), help=_shelp_(defaults, key))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Create secondary option groups from defaults</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">inline_comments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># FIXME: always empty!</span>
            <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;# &quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">desc</span><span class="p">]</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">)</span>
            <span class="n">defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span>
                <span class="n">_walker_argcfg_setarg_</span><span class="p">,</span>
                <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">call_on_sections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
                <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span>
                <span class="n">nested</span><span class="o">=</span><span class="n">nested</span><span class="p">,</span>
                <span class="n">boolean_false</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_boolean_false</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Now create a configuration instance from passed options</span>
        <span class="k">if</span> <span class="n">parse</span><span class="p">:</span>

            <span class="c1"># Which args ?</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1"># Parse</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

            <span class="c1"># Create a configuration to feed</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigObj</span><span class="p">(</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_interpolation</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span>
            <span class="p">)</span>

            <span class="c1"># Initial config from defaults or the one supplied</span>
            <span class="k">if</span> <span class="n">patch</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
                    <span class="n">cfg</span><span class="p">,</span> <span class="n">patch</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">ConfigObj</span><span class="p">)</span> <span class="k">else</span> <span class="n">defaults</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">cfgfilepatch</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">cfgfilepatch</span><span class="p">,</span> <span class="nb">str</span>
                <span class="p">)</span> <span class="ow">and</span> <span class="n">cfgfilepatch</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">):</span>
                    <span class="n">cfgfilepatch</span> <span class="o">=</span> <span class="s2">&quot;after&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cfgfilepatch</span> <span class="o">=</span> <span class="s2">&quot;before&quot;</span>

            <span class="c1"># Feed config with cfgfile before command line options</span>
            <span class="k">if</span> <span class="n">cfgfilepatch</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s2">&quot;cfgfile&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">))</span>

            <span class="c1"># Feed config with command line options</span>
            <span class="n">defaults</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span>
                <span class="n">_walker_argcfg_setcfg_</span><span class="p">,</span>
                <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">call_on_sections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                <span class="n">nested</span><span class="o">=</span><span class="n">nested</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Feed config with cfgfile after command line options</span>
            <span class="k">if</span> <span class="n">cfgfilepatch</span> <span class="o">==</span> <span class="s2">&quot;after&quot;</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s2">&quot;cfgfile&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">getparser</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">getargs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cfg</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="p">,)</span>
            <span class="k">if</span> <span class="n">getparser</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="p">(</span><span class="n">parser</span><span class="p">,)</span>
            <span class="k">if</span> <span class="n">getargs</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">vacumm_cfg</span> <span class="o">=</span> <span class="n">cfg</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="p">(</span><span class="n">options</span><span class="p">,)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="ConfigManager.arg_patch"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.arg_patch.html#xoa.cfgm.ConfigManager.arg_patch">[docs]</a>    <span class="k">def</span> <span class="nf">arg_patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="p">[],</span> <span class="n">cfgfileopt</span><span class="o">=</span><span class="s2">&quot;cfgfile&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call to :meth:`arg_parse` and :meth:`patch`</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        :class:`~configobj.ConfigObj`</span>
<span class="sd">        :class:`OptionParser`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a patch configuration from commandline arguments</span>
        <span class="n">cfgpatch</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_parse</span><span class="p">(</span>
            <span class="n">parser</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">cfgfileopt</span><span class="o">=</span><span class="n">cfgfileopt</span><span class="p">,</span> <span class="n">getargs</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1">#  Load personal config file and default values</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">)</span>

        <span class="c1">#  Patch it with commandline options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfgpatch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">args</span></div>

<div class="viewcode-block" id="ConfigManager.arg_long_help"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.arg_long_help.html#xoa.cfgm.ConfigManager.arg_long_help">[docs]</a>    <span class="k">def</span> <span class="nf">arg_long_help</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">usage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Long help based on config specs&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the generic long help from config specs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rst: optional</span>
<span class="sd">            Reformat output in rst.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Standard options</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span>
            <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="s2">&quot;--help&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show a reduced help&quot;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--long-help&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show an extended help&quot;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--short-help&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show a very reduced help&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Configuration options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_parse</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rst</span><span class="p">:</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">ArgHelpFormatter</span><span class="p">(</span><span class="n">max_help_position</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">action_group</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_action_groups</span><span class="p">:</span>
                <span class="n">formatter</span><span class="o">.</span><span class="n">start_section</span><span class="p">(</span><span class="n">action_group</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                <span class="n">formatter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">action_group</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                <span class="n">formatter</span><span class="o">.</span><span class="n">add_arguments</span><span class="p">(</span><span class="n">action_group</span><span class="o">.</span><span class="n">_group_actions</span><span class="p">)</span>
                <span class="n">formatter</span><span class="o">.</span><span class="n">end_section</span><span class="p">()</span>
            <span class="n">shelp</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format_help</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shelp</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">format_help</span><span class="p">()</span>

        <span class="c1"># Encoding</span>
        <span class="n">shelp</span> <span class="o">=</span> <span class="n">shelp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">(),</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>

        <span class="c1"># Convert to rst</span>
        <span class="k">if</span> <span class="n">rst</span><span class="p">:</span>
            <span class="n">shelp</span> <span class="o">=</span> <span class="n">opt2rst</span><span class="p">(</span><span class="n">shelp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shelp</span></div>

<div class="viewcode-block" id="ConfigManager.get_rst"><a class="viewcode-back" href="../../api/xoa.cfgm.ConfigManager.get_rst.html#xoa.cfgm.ConfigManager.get_rst">[docs]</a>    <span class="k">def</span> <span class="nf">get_rst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;specs&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the default config to rst with :func:`cfg2rst`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cfg2rst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="filter_section"><a class="viewcode-back" href="../../api/xoa.cfgm.filter_section.html#xoa.cfgm.filter_section">[docs]</a><span class="k">def</span> <span class="nf">filter_section</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">cfgfilter</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursively filter a section according to a dict of specifications</span>

<span class="sd">    When encountering an option of ``sec``, it removed if its value</span>
<span class="sd">    in ``cfgfilter`` is set to False. When not found, it default to the</span>
<span class="sd">    ``__default__`` key of ``cfgfilter``. And if the ``__default__`` is not</span>
<span class="sd">    found, it defaults to ``False`` (filtered out).</span>
<span class="sd">    When an option is a section and its value in ``cfgfilter`` is a dictionary,</span>
<span class="sd">    this subsection is filtered in the same way with the value as restrictions</span>
<span class="sd">    (``cfgfilter[subsection]``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sec:</span>
<span class="sd">        A :class:`configobj.Section` instance.</span>
<span class="sd">    cfgfilter:</span>
<span class="sd">        A dictionary tree with the same structure as ``sec``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Default behavior</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">cfgfilter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__default__&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="c1"># Exceptions</span>
    <span class="n">excepts</span> <span class="o">=</span> <span class="n">cfgfilter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__excepts__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">excepts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">excepts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">excepts</span> <span class="o">=</span> <span class="p">[</span><span class="n">excepts</span><span class="p">]</span>

    <span class="c1"># First pass on level 0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sec</span><span class="p">:</span>
        <span class="n">kdefault</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">default</span> <span class="k">if</span> <span class="n">excepts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excepts</span> <span class="k">else</span> <span class="ow">not</span> <span class="n">default</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfgfilter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">kdefault</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">sec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="c1"># Filter subsections</span>
    <span class="k">for</span> <span class="n">subsec</span> <span class="ow">in</span> <span class="n">sec</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subsec</span> <span class="ow">in</span> <span class="n">cfgfilter</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfgfilter</span><span class="p">[</span><span class="n">subsec</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">filter_section</span><span class="p">(</span><span class="n">sec</span><span class="p">[</span><span class="n">subsec</span><span class="p">],</span> <span class="n">cfgfilter</span><span class="p">[</span><span class="n">subsec</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sec</span></div>


<div class="viewcode-block" id="cfgargparse"><a class="viewcode-back" href="../../api/xoa.cfgm.cfgargparse.html#xoa.cfgm.cfgargparse">[docs]</a><span class="k">def</span> <span class="nf">cfgargparse</span><span class="p">(</span>
    <span class="n">cfgspecfile</span><span class="p">,</span>
    <span class="n">parser</span><span class="p">,</span>
    <span class="n">cfgfileopt</span><span class="o">=</span><span class="s2">&quot;cfgfile&quot;</span><span class="p">,</span>
    <span class="n">cfgfile</span><span class="o">=</span><span class="s2">&quot;config.cfg&quot;</span><span class="p">,</span>
    <span class="n">exc</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">extraopts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Merge configuration and commandline arguments</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cfgspecfile:</span>
<span class="sd">        Config specification file (.ini).</span>
<span class="sd">    parser:</span>
<span class="sd">        :class:`~argpase.ArgumentParser` instance.</span>
<span class="sd">    cfgfileopt: optional</span>
<span class="sd">        Name of the option used to specify the</span>
<span class="sd">        user config file. Example: ``&#39;cfgfile&#39;`` creates the option</span>
<span class="sd">        ``--cfgfile=&lt;config file&gt;``.</span>
<span class="sd">    cfgfile: optional</span>
<span class="sd">        Default name for the loaded config file.</span>
<span class="sd">    exc: optional</span>
<span class="sd">        Config option name that must not be used to generated</span>
<span class="sd">        a commandline option.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Extra params are passed to :class:`ConfigManager` initialization.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    :class:`ConfigObj`</span>

<span class="sd">    Tasks:</span>

<span class="sd">        1. Initialize a default configuration (:class:`ConfigManager`)</span>
<span class="sd">           from the specification file given by ``cfgspecfile``.</span>
<span class="sd">        2. Generate associated commandline options.</span>
<span class="sd">        3. Load a user configuration file (specified with the option</span>
<span class="sd">           whose name is given by ``cfgfileopt``).</span>
<span class="sd">        4. Patch this configuration with user supplied options retrieved</span>
<span class="sd">           using the :class:`~argpase.ArgumentParser` parser ``parser``.</span>

<span class="sd">        Technically it combines :class:`ConfigManager` and</span>
<span class="sd">        :meth:`ConfigManager.arg_parse`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="n">cfgspecfile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">arg_parse</span><span class="p">(</span>
        <span class="n">parser</span><span class="p">,</span>
        <span class="n">cfgfileopt</span><span class="o">=</span><span class="n">cfgfileopt</span><span class="p">,</span>
        <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span>
        <span class="n">cfgfile</span><span class="o">=</span><span class="n">cfgfile</span><span class="p">,</span>
        <span class="n">getargs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extraopts</span><span class="o">=</span><span class="n">extraopts</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="opt2rst"><a class="viewcode-back" href="../../api/xoa.cfgm.opt2rst.html#xoa.cfgm.opt2rst">[docs]</a><span class="k">def</span> <span class="nf">opt2rst</span><span class="p">(</span><span class="n">shelp</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">secfmt</span><span class="o">=</span><span class="s2">&quot;:</span><span class="si">{secname}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="n">descname</span><span class="o">=</span><span class="s2">&quot;Description&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert --help str to rst</span>

<span class="sd">    This is useful for autodocumenting executable python scripts</span>
<span class="sd">    that show a formatted help.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shelp: str</span>
<span class="sd">        Help string showing options (results from :option:``--help``).</span>
<span class="sd">    prog: optional, str</span>
<span class="sd">        Program name, otherwise guess it from usage.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    str</span>
<span class="sd">        String converted to rst format (with :rst:dir:`cmdoption` directives).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rhelp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">multiline</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">s_param</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:\{[\w,]+\}|\w+)&quot;</span>
    <span class="n">s_sopt</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;(?:-\w+(?: </span><span class="si">{</span><span class="n">s_param</span><span class="si">}</span><span class="s2">)?)&quot;</span>  <span class="c1"># short option (-t)</span>
    <span class="c1"># long option (--toto)</span>
    <span class="n">s_lopt</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;(?:--[\w\-]+(?:[= ]+</span><span class="si">{</span><span class="n">s_param</span><span class="si">}</span><span class="s2">)?)&quot;</span>
    <span class="n">s_optsep</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:, +)&quot;</span>  <span class="c1"># option separator</span>
    <span class="n">s_desc</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:  (.+))&quot;</span>
    <span class="n">s_tot</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">rf</span><span class="s2">&quot;^  (?:  )?((?:</span><span class="si">{</span><span class="n">s_sopt</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">s_lopt</span><span class="si">}</span><span class="s2">)(?:</span><span class="si">{</span><span class="n">s_optsep</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">rf</span><span class="s2">&quot;(?:</span><span class="si">{</span><span class="n">s_sopt</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">s_lopt</span><span class="si">}</span><span class="s2">))*)</span><span class="si">{</span><span class="n">s_desc</span><span class="si">}</span><span class="s2">?$&quot;</span>
    <span class="p">)</span>
    <span class="n">re_opt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">s_tot</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
    <span class="n">re_sec</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:  )?([\w\s]+):(?: (.+))?$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
    <span class="n">secname</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">shelp</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>

        <span class="c1"># Sections</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re_sec</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;ex:&quot;</span><span class="p">):</span>

            <span class="n">secname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Usage</span>
            <span class="k">if</span> <span class="n">secname</span> <span class="o">==</span> <span class="s2">&quot;Usage&quot;</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">usage</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">prog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">prog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">rhelp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.. program:: </span><span class="si">{</span><span class="n">prog</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">rhelp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">secfmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">locals</span><span class="p">()),</span>
                        <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">.. code-block:: bash</span><span class="se">\n\n\t\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">usage</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">multiline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rhelp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">secfmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">locals</span><span class="p">()),</span> <span class="s2">&quot;&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rhelp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
                    <span class="n">multiline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="c1"># Options and other lines</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re_opt</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>

            <span class="n">rhelp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">.. cmdoption:: &quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">])</span>
            <span class="n">multiline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rhelp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">secname</span>
            <span class="ow">and</span> <span class="n">secname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;positional arguments&quot;</span>
            <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">):</span>

            <span class="n">sline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">rhelp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">.. cmdoption:: &quot;</span> <span class="o">+</span> <span class="n">sline</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">])</span>
            <span class="n">multiline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">rhelp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sline</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="k">elif</span> <span class="n">multiline</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">3</span><span class="p">):</span>

            <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">secname</span> <span class="o">==</span> <span class="s2">&quot;Usage&quot;</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
            <span class="n">rhelp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="c1"># elif secname==descname:</span>
        <span class="c1">#    rhelp.append(&#39;\t&#39;+line)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">secname</span> <span class="ow">and</span> <span class="n">secname</span> <span class="o">==</span> <span class="n">descname</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
            <span class="n">rhelp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">multiline</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">secname</span> <span class="o">==</span> <span class="s2">&quot;Usage&quot;</span><span class="p">:</span>
                <span class="n">secname</span> <span class="o">=</span> <span class="n">descname</span>
                <span class="n">rhelp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">secfmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">locals</span><span class="p">()),</span> <span class="s2">&quot;&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rhelp</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_opt2cfgname_</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">nested</span><span class="p">):</span>
    <span class="n">cfgkey</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nested</span> <span class="ow">and</span> <span class="n">cfgkey</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">nested</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">):</span>
        <span class="n">cfgkey</span> <span class="o">=</span> <span class="n">cfgkey</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">nested</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">cfgkey</span>


<span class="n">_re_cfg2optname_sub</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[_\s]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span>


<span class="k">def</span> <span class="nf">_cfg2optname_</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">optkey</span> <span class="o">=</span> <span class="n">_re_cfg2optname_sub</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
        <span class="n">optkey</span> <span class="o">=</span> <span class="n">nested</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">optkey</span>
    <span class="k">return</span> <span class="n">optkey</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_attdict_</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>


<div class="viewcode-block" id="get_spec"><a class="viewcode-back" href="../../api/xoa.cfgm.get_spec.html#xoa.cfgm.get_spec">[docs]</a><span class="k">def</span> <span class="nf">get_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get an option specification</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spec:</span>
<span class="sd">        the specification string</span>
<span class="sd">    validator:</span>
<span class="sd">        (optional) the validator to use</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    dict</span>
<span class="sd">        A dict with keys:</span>

<span class="sd">        funcname:</span>
<span class="sd">            the validation function name</span>
<span class="sd">        args:</span>
<span class="sd">            the positionnal arguments</span>
<span class="sd">        kwargs:</span>
<span class="sd">            the named arguments</span>
<span class="sd">        default:</span>
<span class="sd">            the default value</span>
<span class="sd">        iterable:</span>
<span class="sd">            if the value is list-like</span>
<span class="sd">        func:</span>
<span class="sd">            the validation function</span>
<span class="sd">        opttype:</span>
<span class="sd">            the function used with :mod:`optparse`</span>
<span class="sd">        argtype:</span>
<span class="sd">            the function used with :mod:`argparse`</span>

<span class="sd">    Read access to these keys can also be done as attribute</span>
<span class="sd">    of the returned dict (d.funcname == d[&#39;funcname&#39;], ...)</span>

<span class="sd">    For example, a specification file containing::</span>

<span class="sd">        [section]</span>
<span class="sd">            option = integer(default=0, min=-10, max=10)</span>

<span class="sd">    Would return::</span>

<span class="sd">        ``{&#39;funcname&#39;: integer, &#39;args&#39;: [],</span>
<span class="sd">        &#39;kwargs&#39;: {&#39;min&#39;: &#39;-10&#39;, &#39;max&#39;: &#39;10&#39;}, &#39;default:&#39; 0,</span>
<span class="sd">        &#39;opttype&#39;: &#39;int&#39;, &#39;argtype&#39;: int,</span>
<span class="sd">        &#39;func&#39;:is_integer, &#39;iterable&#39;: None}</span>

<span class="sd">    This can be usefull when you added extraneous named arguments into your</span>
<span class="sd">    specification file for your own use.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">validator</span><span class="p">:</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">get_validator</span><span class="p">()</span>
    <span class="n">funcname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">_parse_with_caching</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">VALIDATOR_SPECS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">funcname</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iterable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opttype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">argtype</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">funcname</span><span class="o">=</span><span class="n">funcname</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">_attdict_</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_validator"><a class="viewcode-back" href="../../api/xoa.cfgm.get_validator.html#xoa.cfgm.get_validator">[docs]</a><span class="k">def</span> <span class="nf">get_validator</span><span class="p">(</span><span class="n">functions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">Validator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a default validator&quot;&quot;&quot;</span>

    <span class="c1"># Init</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># This modules&#39;s validator functions are already wrapped</span>
    <span class="n">validator</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">VALIDATOR_FUNCTIONS</span><span class="p">)</span>

    <span class="c1"># User defined functions</span>
    <span class="k">if</span> <span class="n">functions</span><span class="p">:</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span>

    <span class="c1"># Wrap default functions to handle none and extra args</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">validator</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_valwrap_</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">validator</span></div>


<span class="k">def</span> <span class="nf">_walker_remove_all_comments_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">sec</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">sec</span><span class="o">.</span><span class="n">inline_comments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_walker_remove_comments_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">sec</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_walker_remove_inline_comments_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">sec</span><span class="o">.</span><span class="n">inline_comments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_walker_unchanged_options_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sec</span><span class="o">.</span><span class="n">configspec</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">get_spec</span><span class="p">(</span><span class="n">sec</span><span class="o">.</span><span class="n">configspec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">spec</span><span class="o">.</span><span class="n">default</span> <span class="o">==</span> <span class="n">sec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<div class="viewcode-block" id="remove_defaults"><a class="viewcode-back" href="../../api/xoa.cfgm.remove_defaults.html#xoa.cfgm.remove_defaults">[docs]</a><span class="k">def</span> <span class="nf">remove_defaults</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_walker_unchanged_options_</span><span class="p">,</span> <span class="n">call_on_sections</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="n">remove</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_walker_argcfg_setcfg_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Walker to set config values&quot;&quot;&quot;</span>
    <span class="c1"># Find genealogy</span>
    <span class="n">parents</span> <span class="o">=</span> <span class="n">_parent_list_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cfgkey</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">_get_kwargs</span><span class="p">():</span>

        <span class="c1"># Option not set</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Option matches key?</span>
        <span class="k">if</span> <span class="n">_opt2cfgname_</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">nested</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cfgkey</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="c1"># Check or create cfg genealogy</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">s</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">_walker_argcfg_setarg_</span><span class="p">(</span>
    <span class="n">sec</span><span class="p">,</span>
    <span class="n">key</span><span class="p">,</span>
    <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">exc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nested</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">boolean_false</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Walker to set options&quot;&quot;&quot;</span>
    <span class="c1"># Find option key and output var name</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">_parent_list_</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
    <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pp</span> <span class="o">+</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="n">optkey</span> <span class="o">=</span> <span class="n">_cfg2optname_</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">nested</span><span class="p">)</span>

    <span class="c1"># Check exceptions</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">sec</span><span class="o">.</span><span class="n">configspec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sec</span><span class="o">.</span><span class="n">configspec</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">VALIDATOR_SPECS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sec</span><span class="o">.</span><span class="n">configspec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{})</span>

    <span class="c1"># Define the wrapping function for argparse argument types</span>
    <span class="c1"># which also handle list values</span>
    <span class="k">def</span> <span class="nf">wrap_argparse_type</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">islist</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapper_argparse_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">islist</span><span class="p">:</span>  <span class="c1"># Use configobj list parser</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">ConfigObj</span><span class="p">(</span>
                    <span class="n">list_values</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span>
                <span class="p">)</span><span class="o">.</span><span class="n">_handle_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">wrapper_argparse_type</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="n">wrapper_argparse_type</span>

    <span class="c1"># Add argument to group</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">wrap_argparse_type</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">),</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iterable&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">boolean_false</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opttype&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;boolean&quot;</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">sec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;store_true&quot;</span> <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">else</span> <span class="s2">&quot;store_false&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;store&quot;</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">optkey</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">_shelp_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_shelp_</span><span class="p">(</span>
    <span class="n">sec</span><span class="p">,</span>
    <span class="n">key</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{shelp}</span><span class="s2"> [default: {default)r]&quot;</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">undoc</span><span class="o">=</span><span class="s2">&quot;Undocumented&quot;</span><span class="p">,</span>
    <span class="n">adddot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get help string</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mode: string</span>

<span class="sd">        - inline: inline comment only,</span>
<span class="sd">        - above: above comments only,</span>
<span class="sd">        - merge: merge inline and above comments,</span>
<span class="sd">        - auto: if one is empty use the other one, else use inline</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># filter</span>
    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">abcoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sec</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]))</span>
    <span class="n">incoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sec</span><span class="o">.</span><span class="n">inline_comments</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># Merge comments above item and its inline comment</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;merge&quot;</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="n">abcoms</span> <span class="o">+</span> <span class="n">incoms</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">incoms</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="n">abcoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="n">incoms</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;above&quot;</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="n">abcoms</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="n">incoms</span>

    <span class="c1"># Force comments to end with a dot &#39;.&#39;</span>
    <span class="k">if</span> <span class="n">adddot</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">]</span>
    <span class="n">shelp</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>

    <span class="c1"># If no comments</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">shelp</span><span class="p">:</span>
        <span class="n">shelp</span> <span class="o">=</span> <span class="n">undoc</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">_sdefault_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_sdefault_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get default string or None&quot;&quot;&quot;</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">sec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;()&quot;</span><span class="p">)</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">default</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">default</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">default</span>


<span class="k">def</span> <span class="nf">_parent_list_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">sec</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parents</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">names</span> <span class="ow">and</span> <span class="n">sec</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sec</span><span class="p">)</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="n">sec</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">return</span> <span class="n">parents</span>


<span class="k">def</span> <span class="nf">_walker_patch_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">patch_key</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cfgpatch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Walk through the patch to apply it&quot;&quot;&quot;</span>
    <span class="n">psec</span> <span class="o">=</span> <span class="n">cfgpatch</span>
    <span class="n">csec</span> <span class="o">=</span> <span class="n">cfg</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_parent_list_</span><span class="p">(</span><span class="n">sec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psec</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>  <span class="c1"># nothing to patch</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">csec</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="n">csec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">csec</span> <span class="o">=</span> <span class="n">csec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">psec</span> <span class="o">=</span> <span class="n">psec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">patch_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psec</span><span class="p">:</span>  <span class="c1"># nothing to patch</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">patch_key</span> <span class="ow">in</span> <span class="n">csec</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">psec</span><span class="p">[</span><span class="n">patch_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">csec</span><span class="p">[</span><span class="n">patch_key</span><span class="p">])(</span><span class="n">psec</span><span class="p">[</span><span class="n">patch_key</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">csec</span><span class="p">[</span><span class="n">patch_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">psec</span><span class="p">[</span><span class="n">patch_key</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_walker_set_boolean_false_by_default_</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">validator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">check</span> <span class="o">=</span> <span class="n">sec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">fun_name</span><span class="p">,</span> <span class="n">fun_args</span><span class="p">,</span> <span class="n">fun_kwargs</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">_parse_with_caching</span><span class="p">(</span>
        <span class="n">check</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">fun_name</span> <span class="o">==</span> <span class="s2">&quot;boolean&quot;</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fun_args</span> <span class="ow">or</span> <span class="n">fun_kwargs</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">check</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;, default=False)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">check</span> <span class="o">+</span> <span class="s2">&quot;(default=False)&quot;</span>
        <span class="n">sec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">check</span>


<div class="viewcode-block" id="get_sec_names"><a class="viewcode-back" href="../../api/xoa.cfgm.get_sec_names.html#xoa.cfgm.get_sec_names">[docs]</a><span class="k">def</span> <span class="nf">get_sec_names</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get section names as list from top to bottom [&#39;sec0&#39;,&#39;sec1&#39;,...]&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">secnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">cfg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">secnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">secnames</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_cfg_path"><a class="viewcode-back" href="../../api/xoa.cfgm.get_cfg_path.html#xoa.cfgm.get_cfg_path">[docs]</a><span class="k">def</span> <span class="nf">get_cfg_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">entry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a string representing the path of a ConfigObj through sections</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cfg: configobj.ConfigObj</span>
<span class="sd">    entry: str, None</span>
<span class="sd">    sep: str</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; c=configobj.ConfigObj({&#39;a&#39;:{&#39;b&#39;:{&#39;c&#39;:&#39;d&#39;}}})</span>
<span class="sd">    &gt;&gt;&gt; get_cfg_path(c[&#39;a&#39;][&#39;b&#39;])</span>
<span class="sd">    &#39;a.b&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_cfg_path(c[&#39;a&#39;], &#39;b&#39;)</span>
<span class="sd">    &#39;a.b&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_cfg_path(c[&#39;a&#39;][&#39;b&#39;], &#39;c&#39;, &#39;::&#39;)</span>
<span class="sd">    &#39;a::b::c&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ancestors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="n">curcfg</span> <span class="o">=</span> <span class="n">cfg</span>
    <span class="k">while</span> <span class="n">curcfg</span><span class="o">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">curcfg</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">curcfg</span><span class="p">:</span>
        <span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curcfg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">curcfg</span> <span class="o">=</span> <span class="n">curcfg</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">ancestors</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_redent</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s2">&quot;    &quot;</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<div class="viewcode-block" id="cfg2rst"><a class="viewcode-back" href="../../api/xoa.cfgm.cfg2rst.html#xoa.cfgm.cfg2rst">[docs]</a><span class="k">def</span> <span class="nf">cfg2rst</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="n">optrole</span><span class="o">=</span><span class="s2">&quot;confopt&quot;</span><span class="p">,</span> <span class="n">secrole</span><span class="o">=</span><span class="s2">&quot;confsec&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a configuration to rst format</span>

<span class="sd">    Configuration sections are declared with the rst directive</span>
<span class="sd">    &quot;confsec&quot; and options are declared with the rst directive</span>
<span class="sd">    &quot;confopt&quot;.</span>

<span class="sd">    For instance:</span>

<span class="sd">    .. code-block:: ini</span>

<span class="sd">        a=1 # desc a</span>
<span class="sd">        [s1] # desc s1</span>
<span class="sd">            b=2  # desc b</span>
<span class="sd">            [[s2]] # desc s2</span>
<span class="sd">                c=$a-$b # desd c</span>
<span class="sd">                [sec1] # section 1</span>

<span class="sd">    is converted to:</span>

<span class="sd">    .. code-block:: rst</span>

<span class="sd">        .. confopt:: a</span>

<span class="sd">            desc a</span>

<span class="sd">        .. confsec:: [s1]</span>

<span class="sd">            desc s1</span>

<span class="sd">            .. confopt:: [s1] b</span>

<span class="sd">                desc b</span>

<span class="sd">            .. confsec:: [s1][s2]</span>

<span class="sd">                desc s2</span>

<span class="sd">                .. confopt:: [s1][s2] c</span>

<span class="sd">                    desd c</span>

<span class="sd">    Then one can reference an option with for example ``:confopt:`[s1][s2]c`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cfg: :class:`ConfigObj`, :class:`ConfigManager`</span>
<span class="sd">        In the case of a :class:`ConfigManager`,</span>
<span class="sd">        the :meth:`~ConfigManager.defaults`</span>
<span class="sd">        are used.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ConfigManager</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;specs&quot;</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">specs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">defaults</span><span class="p">()</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span>
        <span class="n">_walker_cfg2rst_</span><span class="p">,</span>
        <span class="n">call_on_sections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lines</span><span class="o">=</span><span class="n">lines</span><span class="p">,</span>
        <span class="n">optrole</span><span class="o">=</span><span class="n">optrole</span><span class="p">,</span>
        <span class="n">secrole</span><span class="o">=</span><span class="n">secrole</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_walker_cfg2rst_</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">,</span>
    <span class="n">key</span><span class="p">,</span>
    <span class="n">lines</span><span class="p">,</span>
    <span class="n">optrole</span><span class="o">=</span><span class="s2">&quot;cfgopt&quot;</span><span class="p">,</span>
    <span class="n">secrole</span><span class="o">=</span><span class="s2">&quot;cfgsec&quot;</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span>
    <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dir_fmt</span><span class="o">=</span><span class="s2">&quot;.. </span><span class="si">{conftype}</span><span class="s2">:: </span><span class="si">{name}</span><span class="se">\n\n</span><span class="si">{desc}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">desc_fmt_desc_item</span><span class="o">=</span><span class="s2">&quot;| </span><span class="si">{key}</span><span class="s2">: ``</span><span class="si">{val}</span><span class="s2">``</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">):</span>

    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="s2">&quot;specs&quot;</span><span class="p">)</span>

    <span class="c1"># Name, values and type</span>
    <span class="n">secnames</span> <span class="o">=</span> <span class="n">get_sec_names</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">specs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>  <span class="c1"># section</span>

        <span class="n">secnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;][&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">secnames</span><span class="p">))</span>
        <span class="n">conftype</span> <span class="o">=</span> <span class="n">secrole</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># option</span>

        <span class="k">if</span> <span class="n">secnames</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;][&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">secnames</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">conftype</span> <span class="o">=</span> <span class="n">optrole</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;values&quot;</span><span class="p">:</span>

            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;specs&quot;</span><span class="p">:</span>

            <span class="n">spec</span> <span class="o">=</span> <span class="n">get_spec</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">)</span>
            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;funcname&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                <span class="n">skey</span> <span class="o">=</span> <span class="s2">&quot;possible choices&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;choice&quot;</span> <span class="k">else</span> <span class="s2">&quot;args&quot;</span>
                <span class="n">specs</span><span class="p">[</span><span class="n">skey</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]:</span>
                <span class="n">specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">specs</span><span class="p">:</span>  <span class="c1"># join lists</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">specs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="c1"># Description</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">inline_comments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

    <span class="c1"># Formatting</span>
    <span class="c1"># - description with specs</span>
    <span class="k">if</span> <span class="n">specs</span><span class="p">:</span>
        <span class="n">sdesc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
            <span class="n">sdesc</span> <span class="o">=</span> <span class="n">sdesc</span> <span class="o">+</span> <span class="n">desc_fmt_desc_item</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">sdesc</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">desc</span>
    <span class="c1"># - directive</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">_redent</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">dir_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">_redent</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>


<div class="viewcode-block" id="print_short_help"><a class="viewcode-back" href="../../api/xoa.cfgm.print_short_help.html#xoa.cfgm.print_short_help">[docs]</a><span class="k">def</span> <span class="nf">print_short_help</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print all help of a parser instance but those of groups&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">ArgumentParser</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">formatter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_get_formatter</span><span class="p">()</span>

        <span class="c1"># usage</span>
        <span class="k">if</span> <span class="n">compressed</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">compressed</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;-h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-help&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--long-help&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--short-help&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--cfgfile&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">compressed</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compressed</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">compressed</span> <span class="o">=</span> <span class="p">[</span><span class="n">compressed</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">compressed</span><span class="p">:</span>
            <span class="n">fake_action</span> <span class="o">=</span> <span class="n">AP_Action</span><span class="p">([</span><span class="s2">&quot;other-options&quot;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">valid_option</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">option_strings</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">optstr</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">option_strings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">optstr</span> <span class="ow">in</span> <span class="n">compressed</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>

            <span class="n">actions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">valid_option</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">_actions</span><span class="p">))</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fake_action</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_actions</span>
        <span class="n">formatter</span><span class="o">.</span><span class="n">add_usage</span><span class="p">(</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">usage</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">_mutually_exclusive_groups</span>
        <span class="p">)</span>

        <span class="c1"># description</span>
        <span class="n">formatter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># positionals, optionals and user-defined groups</span>
        <span class="k">for</span> <span class="n">action_group</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_action_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">action_group</span><span class="o">.</span><span class="n">title</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;positional arguments&quot;</span><span class="p">,</span>
                <span class="s2">&quot;optional arguments&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">formatter</span><span class="o">.</span><span class="n">start_section</span><span class="p">(</span><span class="n">action_group</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                <span class="n">formatter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">action_group</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                <span class="n">formatter</span><span class="o">.</span><span class="n">add_arguments</span><span class="p">(</span><span class="n">action_group</span><span class="o">.</span><span class="n">_group_actions</span><span class="p">)</span>
                <span class="n">formatter</span><span class="o">.</span><span class="n">end_section</span><span class="p">()</span>

        <span class="c1"># epilog</span>
        <span class="n">formatter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">epilog</span><span class="p">)</span>

        <span class="c1"># determine help from format above</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">_print_message</span><span class="p">(</span><span class="n">formatter</span><span class="o">.</span><span class="n">format_help</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_AP_ShortHelpAction</span><span class="p">(</span><span class="n">_HelpAction</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">print_short_help</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_AP_VeryShortHelpAction</span><span class="p">(</span><span class="n">_HelpAction</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">print_short_help</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Shom/Ifremer/Actimar

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>